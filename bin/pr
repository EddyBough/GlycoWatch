#!/usr/bin/env bash
set -euo pipefail

# 1) Assure un upstream si c'est le 1er push
if ! git rev-parse --abbrev-ref --symbolic-full-name @{u} >/dev/null 2>&1; then
  git push -u origin HEAD
fi

# 2) Récup info commit + base
TITLE="$(git log -1 --pretty=%s || echo 'PR')"
BODY="$(git log -1 --pretty=%b || true)"
BRANCH="$(git branch --show-current)"
DEFAULT_BASE="$(git remote show origin | awk -F': ' '/HEAD branch/ {print $2}')"
BASE="${DEFAULT_BASE:-main}"

# 3) Détecte l'ID d'issue depuis le nom de branche: issue-<ID>-...
ISSUE_ID="$(echo "$BRANCH" | sed -n 's/^issue-\([0-9]\+\)-.*/\1/p')"

# 4) Ajoute "Fixes #ID" automatiquement si absent
if [[ -n "${ISSUE_ID}" ]]; then
  if ! printf "%s" "${BODY}" | grep -qiE "(fixes|closes)\s*#${ISSUE_ID}"; then
    BODY="$(printf "%s\n\nFixes #%s" "${BODY:-}" "${ISSUE_ID}")"
  fi
fi

# 5) Labels (facultatifs)
LABELS="ready,automerge"

# 6) Création PR + auto-merge
gh pr create \
  --title "${TITLE}" \
  --body "${BODY:-}" \
  --base "${BASE}" \
  --label "${LABELS}"

gh pr merge --auto --squash || true
gh pr status
